#!/bin/sh

rm -f config.mk

# TODO: detect mitshm

pkg-config --exists --print-errors x11 xext xt
# Unfortuantly motif (xm) does not have a .pc file.
# so we just have to guess common paths.


# Linking order (LDLIBS) must be exact, otherwise you might get this error:
# "X Error of failed request:  BadWindow (invalid Window parameter)
#  Major opcode of failed request:  19 (X_DeleteProperty)"

# xp is for printing support and is not available in the debian build of motif.
cat >> config.mk <<-EOF
	CFLAGS += -std=c99 $(pkg-config --cflags x11 xext xt xpm) $(pkg-config --silence-errors --cflags xp)
	LDFLAGS += $(pkg-config --libs-only-L x11 xext xt xpm) $(pkg-config --silence-errors --libs-only-L xp)
	LDLIBS += -lm $(pkg-config --libs-only-l x11 xext) -lXm $(pkg-config --libs-only-l xt xpm) $(pkg-config --silence-errors --libs-only-L xp)
	CFLAGS += -I/opt/X11/include 
EOF

# Find motif
if command -v brew > /dev/null
then
	cat >> config.mk <<-EOF
		CFLAGS += -I$(brew --prefix openmotif)/include
		LDFLAGS += -L$(brew --prefix openmotif)/lib
	EOF
fi

X11_PATH_PREFIX=$(pkg-config --variable prefix x11)
echo "CFLAGS += -D_POSIX_C_SOURCE=200809L -D X11_PATH_PREFIX=\\\"${X11_PATH_PREFIX}\\\"" >> config.mk

DEBUG=false
SHM=true

for var in "$@"
do
	if [ "$var" = "--debug" ]
	then
		DEBUG=true
	elif [ "$var" = "--no-shm" ]
	then
		SHM=false
	fi
done

if [ "$DEBUG" = "true" ]
then
	echo "CFLAGS += -D DEBUG_LOG=1 -g" >> config.mk
else
    #-fno-strict-aliasing is specifically a requirement of stb_image_write
	echo "CFLAGS += -D DEBUG_LOG=0 -O3 -ffast-math -fno-strict-aliasing" >> config.mk
fi

if [ "$SHM" = "true" ]
then
	echo "CFLAGS += -D FEATURE_SHM" >> config.mk
fi
