#!/bin/sh

rm -f config.mk

# TODO: detect mitshm

pkg-config --exists --print-errors x11 xext xt
# Unfortuantly motif (xm) does not have a .pc file.
# so we just have to guess common paths.

# Linking order (LDLIBS) must be exact, otherwise you might get this error:
# "X Error of failed request:  BadWindow (invalid Window parameter)
#  Major opcode of failed request:  19 (X_DeleteProperty)"
cat >> config.mk <<-EOF
	CFLAGS += -std=c99
	CFLAGS += $(pkg-config --cflags x11 xext xt xpm) 
	LDFLAGS += -L/usr/local/lib $(pkg-config --libs-only-L x11 xext xt xpm)
	LDLIBS += -lm $(pkg-config --libs-only-l x11 xext) -lXm $(pkg-config --libs-only-l xt xpm)
	CFLAGS += -I/opt/X11/include -I/usr/local/include
EOF

X11_PATH_PREFIX=$(pkg-config --variable prefix x11)

echo "CFLAGS += -D_POSIX_C_SOURCE=200809L -D X11_PATH_PREFIX=\\\"${X11_PATH_PREFIX}\\\"" >> config.mk

DEBUG=false
SHM=true

for var in "$@"
do
	if [ "$var" = "--debug" ]
	then
		DEBUG=true
	elif [ "$var" = "--no-shm" ]
	then
		SHM=false
	fi
done

if [ "$DEBUG" = "true" ]
then
	echo "CFLAGS += -D DEBUG_LOG=1 -g" >> config.mk
else
    #-fno-strict-aliasing is specifically a requirement of stb_image_write
	echo "CFLAGS += -D DEBUG_LOG=0 -O3 -ffast-math -fno-strict-aliasing" >> config.mk
fi

if [ "$SHM" = "true" ]
then
	echo "CFLAGS += -D FEATURE_SHM" >> config.mk
fi
